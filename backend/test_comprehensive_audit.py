#!/usr/bin/env python3
"""
Comprehensive test suite for MobilityHub audit trails and admin CRUD operations
Testing all transactional requests and critical data modifications
"""

import asyncio
import pytest
import json
from datetime import datetime, timedelta, timezone
from motor.motor_asyncio import AsyncIOMotorClient
from fastapi.testclient import TestClient
import os
import sys

# Add backend to path
sys.path.append('/app/backend')

try:
    from server import app, audit_system, admin_crud
    from audit_system import AuditAction, AuditFilter
    from admin_crud import AdminUserUpdate, AdminRideUpdate, AdminPaymentUpdate, DataFilter
    IMPORTS_AVAILABLE = True
except ImportError as e:
    print(f"Warning: Could not import audit system: {e}")
    IMPORTS_AVAILABLE = False

class TestComprehensiveAudit:
    """Test suite for comprehensive audit trails and admin operations"""
    
    def setup_method(self):
        """Setup test environment"""
        self.client = TestClient(app)\n        self.base_url = \"http://localhost:8001/api\"\n        \n        # Test users for different roles\n        self.test_rider = {\n            \"email\": \"test_rider@audit.com\",\n            \"password\": \"testpass123\",\n            \"name\": \"Test Rider\",\n            \"phone\": \"+1234567890\",\n            \"role\": \"rider\"\n        }\n        \n        self.test_driver = {\n            \"email\": \"test_driver@audit.com\",\n            \"password\": \"testpass123\",\n            \"name\": \"Test Driver\",\n            \"phone\": \"+1234567891\",\n            \"role\": \"driver\"\n        }\n        \n        self.test_admin = {\n            \"email\": \"test_admin@audit.com\",\n            \"password\": \"adminpass123\",\n            \"name\": \"Test Admin\",\n            \"phone\": \"+1234567892\",\n            \"role\": \"admin\"\n        }\n        \n        self.tokens = {}\n        self.user_ids = {}\n    \n    def test_01_user_registration_audit(self):\n        \"\"\"Test user registration creates proper audit trails\"\"\"\n        print(\"\\n=== Testing User Registration Audit Trail ===\")\n        \n        # Test successful registration\n        response = self.client.post(\"/api/auth/register\", json=self.test_rider)\n        assert response.status_code == 200\n        \n        data = response.json()\n        assert \"access_token\" in data\n        assert data[\"user\"][\"email\"] == self.test_rider[\"email\"]\n        \n        self.tokens[\"rider\"] = data[\"access_token\"]\n        self.user_ids[\"rider\"] = data[\"user\"][\"id\"]\n        \n        print(f\"✅ Rider registered successfully: {data['user']['id']}\")\n        \n        # Test duplicate registration (should fail and be audited)\n        response = self.client.post(\"/api/auth/register\", json=self.test_rider)\n        assert response.status_code == 400\n        print(\"✅ Duplicate registration properly rejected\")\n        \n        # Register driver and admin\n        for role in [\"driver\", \"admin\"]:\n            test_user = getattr(self, f\"test_{role}\")\n            response = self.client.post(\"/api/auth/register\", json=test_user)\n            assert response.status_code == 200\n            \n            data = response.json()\n            self.tokens[role] = data[\"access_token\"]\n            self.user_ids[role] = data[\"user\"][\"id\"]\n            print(f\"✅ {role.capitalize()} registered successfully\")\n    \n    def test_02_user_login_audit(self):\n        \"\"\"Test user login creates proper audit trails\"\"\"\n        print(\"\\n=== Testing User Login Audit Trail ===\")\n        \n        # Test successful login\n        login_data = {\n            \"email\": self.test_rider[\"email\"],\n            \"password\": self.test_rider[\"password\"]\n        }\n        \n        response = self.client.post(\"/api/auth/login\", json=login_data)\n        assert response.status_code == 200\n        print(\"✅ Successful login audited\")\n        \n        # Test failed login (wrong password)\n        wrong_login = {\n            \"email\": self.test_rider[\"email\"],\n            \"password\": \"wrongpassword\"\n        }\n        \n        response = self.client.post(\"/api/auth/login\", json=wrong_login)\n        assert response.status_code == 401\n        print(\"✅ Failed login attempt audited\")\n        \n        # Test failed login (non-existent user)\n        fake_login = {\n            \"email\": \"nonexistent@test.com\",\n            \"password\": \"password123\"\n        }\n        \n        response = self.client.post(\"/api/auth/login\", json=fake_login)\n        assert response.status_code == 401\n        print(\"✅ Non-existent user login attempt audited\")\n    \n    def test_03_ride_operations_audit(self):\n        \"\"\"Test ride operations create comprehensive audit trails\"\"\"\n        print(\"\\n=== Testing Ride Operations Audit Trail ===\")\n        \n        headers = {\"Authorization\": f\"Bearer {self.tokens['rider']}\"}\n        \n        # Test ride request creation\n        ride_request = {\n            \"pickup_location\": {\n                \"latitude\": 37.7749,\n                \"longitude\": -122.4194,\n                \"address\": \"123 Test St, San Francisco, CA\"\n            },\n            \"dropoff_location\": {\n                \"latitude\": 37.7849,\n                \"longitude\": -122.4094,\n                \"address\": \"456 Test Ave, San Francisco, CA\"\n            },\n            \"vehicle_type\": \"economy\",\n            \"passenger_count\": 2\n        }\n        \n        response = self.client.post(\"/api/rides/request\", json=ride_request, headers=headers)\n        assert response.status_code == 200\n        \n        ride_data = response.json()\n        ride_id = ride_data[\"request_id\"]\n        print(f\"✅ Ride request created and audited: {ride_id}\")\n        \n        # Test ride acceptance (by driver)\n        driver_headers = {\"Authorization\": f\"Bearer {self.tokens['driver']}\"}\n        \n        response = self.client.post(f\"/api/rides/{ride_id}/accept\", headers=driver_headers)\n        if response.status_code == 200:\n            print(\"✅ Ride acceptance audited\")\n        else:\n            print(f\"⚠️ Ride acceptance failed: {response.status_code} - {response.text}\")\n    \n    def test_04_admin_user_management_audit(self):\n        \"\"\"Test admin user management operations create audit trails\"\"\"\n        print(\"\\n=== Testing Admin User Management Audit Trail ===\")\n        \n        admin_headers = {\"Authorization\": f\"Bearer {self.tokens['admin']}\"}\n        \n        # Test getting users with filters\n        response = self.client.get(\"/api/admin/users/filtered?search=test&limit=10\", headers=admin_headers)\n        if response.status_code == 200:\n            print(\"✅ Admin user list access audited\")\n            users_data = response.json()\n            print(f\"   Found {len(users_data.get('users', []))} users\")\n        else:\n            print(f\"⚠️ Admin user list failed: {response.status_code}\")\n        \n        # Test updating user\n        target_user_id = self.user_ids[\"rider\"]\n        update_data = {\n            \"is_verified\": True,\n            \"rating\": 4.8,\n            \"admin_notes\": \"Test update for audit verification\"\n        }\n        \n        response = self.client.put(\n            f\"/api/admin/users/{target_user_id}/update\",\n            params=update_data,\n            headers=admin_headers\n        )\n        \n        if response.status_code == 200:\n            print(\"✅ Admin user update audited\")\n        else:\n            print(f\"⚠️ Admin user update failed: {response.status_code}\")\n        \n        # Test user suspension\n        response = self.client.post(\n            f\"/api/admin/users/{target_user_id}/suspend\",\n            params={\"reason\": \"Test suspension for audit\", \"duration_days\": 7},\n            headers=admin_headers\n        )\n        \n        if response.status_code == 200:\n            print(\"✅ User suspension audited\")\n        else:\n            print(f\"⚠️ User suspension failed: {response.status_code}\")\n    \n    def test_05_payment_operations_audit(self):\n        \"\"\"Test payment operations create comprehensive audit trails\"\"\"\n        print(\"\\n=== Testing Payment Operations Audit Trail ===\")\n        \n        admin_headers = {\"Authorization\": f\"Bearer {self.tokens['admin']}\"}\n        \n        # Test getting payment transactions with filters\n        response = self.client.get(\"/api/admin/payments/filtered?limit=10\", headers=admin_headers)\n        if response.status_code == 200:\n            print(\"✅ Admin payment list access audited\")\n            payments_data = response.json()\n            print(f\"   Found {len(payments_data.get('payments', []))} payments\")\n            print(f\"   Total revenue: ${payments_data.get('total_revenue', 0):.2f}\")\n        else:\n            print(f\"⚠️ Admin payment list failed: {response.status_code}\")\n    \n    def test_06_audit_log_retrieval(self):\n        \"\"\"Test audit log retrieval and filtering\"\"\"\n        print(\"\\n=== Testing Audit Log Retrieval ===\")\n        \n        admin_headers = {\"Authorization\": f\"Bearer {self.tokens['admin']}\"}\n        \n        # Test getting audit logs\n        response = self.client.get(\"/api/audit/logs?limit=20\", headers=admin_headers)\n        if response.status_code == 200:\n            audit_logs = response.json()\n            print(f\"✅ Retrieved {len(audit_logs)} audit log entries\")\n            \n            # Check for various audit actions\n            actions_found = set()\n            for log in audit_logs:\n                actions_found.add(log.get(\"action\", \"unknown\"))\n            \n            print(f\"   Audit actions found: {', '.join(actions_found)}\")\n        else:\n            print(f\"⚠️ Audit log retrieval failed: {response.status_code}\")\n        \n        # Test getting audit statistics\n        response = self.client.get(\"/api/audit/statistics\", headers=admin_headers)\n        if response.status_code == 200:\n            stats = response.json()\n            print(\"✅ Audit statistics retrieved:\")\n            print(f\"   Total audit logs: {stats.get('total_audit_logs', 0)}\")\n            print(f\"   Recent activity (24h): {stats.get('recent_activity_24h', 0)}\")\n        else:\n            print(f\"⚠️ Audit statistics failed: {response.status_code}\")\n        \n        # Test user-specific audit logs (non-admin)\n        rider_headers = {\"Authorization\": f\"Bearer {self.tokens['rider']}\"}\n        response = self.client.get(\"/api/audit/logs?limit=10\", headers=rider_headers)\n        if response.status_code == 200:\n            user_logs = response.json()\n            print(f\"✅ User can access their own audit logs: {len(user_logs)} entries\")\n        else:\n            print(f\"⚠️ User audit log access failed: {response.status_code}\")\n    \n    def test_07_data_filtering_and_search(self):\n        \"\"\"Test comprehensive data filtering and search capabilities\"\"\"\n        print(\"\\n=== Testing Data Filtering and Search ===\")\n        \n        admin_headers = {\"Authorization\": f\"Bearer {self.tokens['admin']}\"}\n        \n        # Test user search\n        response = self.client.get(\"/api/admin/users/filtered?search=test&role=rider\", headers=admin_headers)\n        if response.status_code == 200:\n            print(\"✅ User search and filtering working\")\n        \n        # Test ride search\n        response = self.client.get(\"/api/admin/rides/filtered?search=Test\", headers=admin_headers)\n        if response.status_code == 200:\n            print(\"✅ Ride search and filtering working\")\n        \n        # Test audit log search\n        response = self.client.get(\"/api/audit/logs?search=user&action=user_created\", headers=admin_headers)\n        if response.status_code == 200:\n            print(\"✅ Audit log search and filtering working\")\n    \n    def test_08_platform_statistics_with_audit(self):\n        \"\"\"Test platform statistics include audit information\"\"\"\n        print(\"\\n=== Testing Platform Statistics with Audit Data ===\")\n        \n        admin_headers = {\"Authorization\": f\"Bearer {self.tokens['admin']}\"}\n        \n        response = self.client.get(\"/api/admin/stats\", headers=admin_headers)\n        assert response.status_code == 200\n        \n        stats = response.json()\n        print(\"✅ Platform statistics retrieved:\")\n        print(f\"   Total users: {stats.get('total_users', 0)}\")\n        print(f\"   Total rides: {stats.get('total_rides', 0)}\")\n        print(f\"   Total revenue: ${stats.get('total_revenue', 0):.2f}\")\n        \n        if \"audit_statistics\" in stats:\n            audit_stats = stats[\"audit_statistics\"]\n            print(f\"   Audit logs: {audit_stats.get('total_audit_logs', 0)}\")\n            print(\"✅ Audit statistics integrated into platform stats\")\n        else:\n            print(\"⚠️ Audit statistics not integrated\")\n    \n    def run_all_tests(self):\n        \"\"\"Run all comprehensive audit tests\"\"\"\n        print(\"🚀 Starting Comprehensive Audit Trail Testing\")\n        print(\"=\" * 60)\n        \n        try:\n            if not IMPORTS_AVAILABLE:\n                print(\"❌ Audit system imports not available\")\n                return False\n                \n            # Run tests in sequence\n            test_methods = [\n                self.test_01_user_registration_audit,\n                self.test_02_user_login_audit,\n                self.test_03_ride_operations_audit,\n                self.test_04_admin_user_management_audit,\n                self.test_05_payment_operations_audit,\n                self.test_06_audit_log_retrieval,\n                self.test_07_data_filtering_and_search,\n                self.test_08_platform_statistics_with_audit\n            ]\n            \n            passed = 0\n            failed = 0\n            \n            for test_method in test_methods:\n                try:\n                    test_method()\n                    passed += 1\n                except Exception as e:\n                    print(f\"❌ {test_method.__name__} failed: {e}\")\n                    failed += 1\n            \n            print(\"\\n\" + \"=\" * 60)\n            print(f\"📊 Test Results: {passed} passed, {failed} failed\")\n            \n            if failed == 0:\n                print(\"🎉 All comprehensive audit tests passed!\")\n                return True\n            else:\n                print(f\"⚠️ {failed} tests failed - review audit implementation\")\n                return False\n                \n        except Exception as e:\n            print(f\"❌ Test suite execution failed: {e}\")\n            return False\n\n\ndef main():\n    \"\"\"Main test execution\"\"\"\n    tester = TestComprehensiveAudit()\n    success = tester.run_all_tests()\n    \n    return 0 if success else 1\n\n\nif __name__ == \"__main__\":\n    exit(main())\n"